# Papermill Job Template
# This template can be used to execute parameterized notebooks via Papermill
# 
# Usage:
#   kubectl create job <job-name> --from=job/papermill-job-template -n ai
#   kubectl set env job/<job-name> \
#     NOTEBOOK_PATH=/path/to/notebook.ipynb \
#     OUTPUT_PATH=/path/to/output.ipynb \
#     PARAMETERS='{"param1":"value1","param2":"value2"}' \
#     -n ai
#   kubectl patch job/<job-name> -p '{"spec":{"template":{"spec":{"volumes":[{"name":"user-pvc","persistentVolumeClaim":{"claimName":"claim-<username>"}}]}}}}' -n ai

apiVersion: batch/v1
kind: Job
metadata:
  name: papermill-job-template
  namespace: ai
  labels:
    app: papermill
    component: notebook-execution
spec:
  ttlSecondsAfterFinished: 3600  # Clean up after 1 hour
  template:
    metadata:
      labels:
        app: papermill
        component: notebook-execution
    spec:
      restartPolicy: Never
      containers:
      - name: papermill
        image: jupyter/scipy-notebook:python-3.10
        command:
          - /bin/bash
          - -c
          - |
            set -e
            echo "Installing papermill and MinIO client..."
            pip install --quiet --no-cache-dir papermill boto3 s3fs
            
            echo "Notebook path: $NOTEBOOK_PATH"
            echo "Output path: $OUTPUT_PATH"
            echo "Parameters: ${PARAMETERS:-{}}"
            
            # Parse parameters if provided
            if [ -n "$PARAMETERS" ]; then
              PARAMS_ARG="--parameters"
              echo "$PARAMETERS" > /tmp/params.json
              PARAMS_ARG="$PARAMS_ARG /tmp/params.json"
            else
              PARAMS_ARG=""
            fi
            
            # Execute notebook with papermill
            if [ -n "$MINIO_ENDPOINT" ] && [ -n "$OUTPUT_TO_MINIO" ] && [ "$OUTPUT_TO_MINIO" = "true" ]; then
              echo "Output will be saved to MinIO bucket: $MINIO_BUCKET"
              # Save to MinIO using boto3
              papermill $NOTEBOOK_PATH /tmp/output.ipynb $PARAMS_ARG || true
              python3 << EOF
import boto3
import json
from pathlib import Path

s3_client = boto3.client(
    's3',
    endpoint_url=f"http://$MINIO_ENDPOINT",
    aws_access_key_id="$MINIO_ACCESS_KEY",
    aws_secret_access_key="$MINIO_SECRET_KEY",
    region_name="$MINIO_REGION"
)

bucket = "$MINIO_BUCKET"
key = "$OUTPUT_PATH".lstrip('/')

s3_client.upload_file('/tmp/output.ipynb', bucket, key)
print(f"Uploaded to s3://{bucket}/{key}")
EOF
            else
              # Save to local path (PVC)
              echo "Output will be saved to: $OUTPUT_PATH"
              papermill $NOTEBOOK_PATH $OUTPUT_PATH $PARAMS_ARG
            fi
            
            echo "Notebook execution completed!"
        env:
        - name: NOTEBOOK_PATH
          value: "/home/jovyan/work/input.ipynb"  # Default, override as needed
        - name: OUTPUT_PATH
          value: "/home/jovyan/work/output.ipynb"  # Default, override as needed
        - name: PARAMETERS
          value: "{}"  # JSON string of parameters, override as needed
        - name: MINIO_ENDPOINT
          valueFrom:
            configMapKeyRef:
              name: minio-config
              key: MINIO_ENDPOINT
        - name: MINIO_BUCKET
          valueFrom:
            configMapKeyRef:
              name: minio-config
              key: MINIO_BUCKET
        - name: MINIO_REGION
          valueFrom:
            configMapKeyRef:
              name: minio-config
              key: MINIO_REGION
        - name: MINIO_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: minio-credentials
              key: accesskey
        - name: MINIO_SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: minio-credentials
              key: secretkey
        - name: OUTPUT_TO_MINIO
          value: "false"  # Set to "true" to save output to MinIO instead of PVC
        volumeMounts:
        - name: user-pvc
          mountPath: /home/jovyan/work
          subPath: work
      volumes:
      - name: user-pvc
        persistentVolumeClaim:
          claimName: claim-username  # Replace with actual PVC name (e.g., claim-<username>)

