# Argo Workflow Template for Papermill Notebook Execution
# This is a reusable template for executing notebooks via Papermill in Argo Workflows
#
# Usage in a Workflow:
#   apiVersion: argoproj.io/v1alpha1
#   kind: Workflow
#   metadata:
#     generateName: notebook-workflow-
#   spec:
#     entrypoint: papermill-notebook
#     templates:
#     - name: papermill-notebook
#       templateRef:
#         name: papermill-template
#         template: papermill-execution
#       arguments:
#         parameters:
#         - name: notebook-path
#           value: "/home/jovyan/work/input.ipynb"
#         - name: output-path
#           value: "/home/jovyan/work/output.ipynb"
#         - name: parameters
#           value: '{"param1":"value1"}'
#         - name: pvc-name
#           value: "claim-username"

apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: papermill-template
  namespace: ai
spec:
  templates:
  - name: papermill-execution
    inputs:
      parameters:
      - name: notebook-path
        description: "Path to input notebook"
        default: "/home/jovyan/work/input.ipynb"
      - name: output-path
        description: "Path to output notebook"
        default: "/home/jovyan/work/output.ipynb"
      - name: parameters
        description: "JSON string of parameters to pass to notebook"
        default: "{}"
      - name: pvc-name
        description: "Name of the PVC to mount (e.g., claim-username)"
        default: "claim-username"
      - name: output-to-minio
        description: "Set to 'true' to save output to MinIO instead of PVC"
        default: "false"
    container:
      image: jupyter/scipy-notebook:python-3.10
      command:
        - /bin/bash
        - -c
        - |
          set -e
          echo "Installing papermill and MinIO client..."
          pip install --quiet --no-cache-dir papermill boto3 s3fs
          
          echo "=== Argo Workflow: Papermill Execution ==="
          echo "Notebook path: {{inputs.parameters.notebook-path}}"
          echo "Output path: {{inputs.parameters.output-path}}"
          echo "Parameters: {{inputs.parameters.parameters}}"
          echo "PVC: {{inputs.parameters.pvc-name}}"
          
          # Parse parameters if provided
          if [ -n "{{inputs.parameters.parameters}}" ] && [ "{{inputs.parameters.parameters}}" != "{}" ]; then
            echo "{{inputs.parameters.parameters}}" > /tmp/params.json
            PARAMS_ARG="--parameters /tmp/params.json"
          else
            PARAMS_ARG=""
          fi
          
          # Execute notebook with papermill
          if [ "{{inputs.parameters.output-to-minio}}" = "true" ]; then
            echo "Output will be saved to MinIO bucket: $MINIO_BUCKET"
            # Save to MinIO using boto3
            papermill "{{inputs.parameters.notebook-path}}" /tmp/output.ipynb $PARAMS_ARG || true
            python3 << EOF
import boto3
import json
from datetime import datetime

s3_client = boto3.client(
    's3',
    endpoint_url=f"http://$MINIO_ENDPOINT",
    aws_access_key_id="$MINIO_ACCESS_KEY",
    aws_secret_access_key="$MINIO_SECRET_KEY",
    region_name="$MINIO_REGION"
)

bucket = "$MINIO_BUCKET"
# Add timestamp to output path
timestamp = datetime.utcnow().strftime("%Y%m%d_%H%M%S")
key = "{{inputs.parameters.output-path}}".lstrip('/').replace('.ipynb', f'_{timestamp}.ipynb')

s3_client.upload_file('/tmp/output.ipynb', bucket, key)
print(f"Uploaded to s3://{bucket}/{key}")
EOF
          else
            # Save to local path (PVC)
            echo "Output will be saved to: {{inputs.parameters.output-path}}"
            papermill "{{inputs.parameters.notebook-path}}" "{{inputs.parameters.output-path}}" $PARAMS_ARG
          fi
          
          echo "Notebook execution completed successfully!"
      env:
      - name: MINIO_ENDPOINT
        valueFrom:
          configMapKeyRef:
            name: minio-config
            key: MINIO_ENDPOINT
      - name: MINIO_BUCKET
        valueFrom:
          configMapKeyRef:
            name: minio-config
            key: MINIO_BUCKET
      - name: MINIO_REGION
        valueFrom:
          configMapKeyRef:
            name: minio-config
            key: MINIO_REGION
      - name: MINIO_ACCESS_KEY
        valueFrom:
          secretKeyRef:
            name: minio-credentials
            key: accesskey
      - name: MINIO_SECRET_KEY
        valueFrom:
          secretKeyRef:
            name: minio-credentials
            key: secretkey
      volumeMounts:
      - name: user-pvc
        mountPath: /home/jovyan/work
        subPath: work
      resources:
        requests:
          memory: "1Gi"
          cpu: "500m"
        limits:
          memory: "2Gi"
          cpu: "1000m"
    volumes:
    - name: user-pvc
      persistentVolumeClaim:
        claimName: "{{inputs.parameters.pvc-name}}"

